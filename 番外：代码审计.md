# 番外：代码审计

## 准备工作

1. 下载开源代码

2. 安装并配置好网站，使其能够实时访问

    

## 一、把握大局

### 网站结构

浏览源码文件夹，了解程序的大致目录

### 入口文件

`index.php`、`admin.php` 文件一般是整个程序的入口，详细读一下 index 文件可以指导程序的架构、运行流程/包含哪些配置文件/包含哪些过滤文件以及包含哪些安全（过滤）相关文件，了解程序的业务逻辑

### 配置文件

一般类似 `config.php` 、`*.ini`、`*.inc`、`*.config`、`*.cnf`、`*.conf` 等，保存了一些数据库相关信息、程序等元信息。首先查看下数据库编码，如果是 gbk 则可能存在**宽字节注入**，如果变量的值用双引号、则可能存在双引号解析代码执行的问题

### 过滤功能

通过**详读公共函数文件**和**安全过滤文件**等，清晰掌握用户输入的数据，哪些被过滤，哪些无过滤，在哪里被过滤了，如何被过滤的，能否绕过过滤的数据。过滤的方式是替换还是正则？有没有 GPC？有没有使用 *addslasher()* 等

### 审计方法

- 通读全文法
    - 麻烦、但全面，通常这样可以了解整个应用的业务逻辑，此法一般是企业针对自身产品的审计，对于小型应用来说，通读法不会太费事
- 敏感函数参数回溯法（shell_exec）
    - 高效、常用。首先要明了哪些函数有可能会被不当使用（此处如果了解了就可以用正则匹配、和相关静态审计工具等去自动化），然后分析敏感函数上下文，追踪参数，尝试控制可控的参数变量
    - 火睛静态代码审计、seay 源代码审计系统等
- 定向功能分析法（如安装问题）
    - 根据程序的业务逻辑来审计
    - 一般流程：首先黑盒体验各个功能，推测可能出现的漏洞；再进行白盒验证
    - 常见功能漏洞（包括但不限于）：
        - 程序的初始安装（安装文件未删、备份文件未删等）
        - 站点信息泄露（测试的 phpinfo/探针 未删，错误反馈，HTTP 头版本泄露等）
        - 文件上传（MIME未验证、回显文件路径、不更改随机文件名、配合解析漏洞等）
        - 文件管理（有些管理员自己留有后门/webshell 或者提供访问接口等）
        - 登陆认证（SQL 注入、特殊字符、水平越权等）
        - 数据库备份恢复
        - 找回密码（未验证邮箱/手机，或者二次验证存在逻辑漏洞等）
        - 验证码（验证码不失效，可重复利用、可预测、可爆破等）

### 推荐流程

把握大局->定向功能分析->敏感参数回溯



## 二、常见的 INI 配置

（PS：可以自己尝试边修改配置边改变代码，以查看配置的效果）

#### 常见配置概览

- 变量相关
- 安全模式
- 上传文件和上传目录
- 错误信息显示
- 魔术引号和远程文件



#### 配置文件

**php.ini**：在 PHP 启动时被读取，对于**服务器模块版本**的 PHP，仅在 web 服务器启动时读取一次，对于 **CGI和CLI版本**的PHP，每次调用都会读取。

Apache 会在启动时把目录转到根目录，会导致 PHP 尝试在**根目录**读取php.ini，如果没有再找别的

在 php.ini 中可以使用环境变量

**.user.ini**：从 5.3.0 版本的 PHP 开始，支持基于单个目录的 .htaccess 风格的 ini 文件。这些配置文件只会被 CGI/FastCGI SAPI 处理。这个功能使得 PECL 的 htscanner 扩展作废。如果使用的服务器是 apache，则用 .htaccess 文件效果相同。

可以在 httpd.conf 里覆盖 php.ini 的值，从而进行更灵活的配置：

```
php_value NAME VALUE
```

**几点注意的**

- 当设置非 bool 类型的指令时，将 VALUE 设置为 none 则会清除先前的设定
- 当设置 bool 类型的指令时，使用 `php_flag name on`
- PHP 常量（如 E_ALL）仅能在 php.ini 中使用，在 httpd.conf 中必须使用相应的掩码值
- 带 SYS 标志的指令只能在 httpd.conf 中的全局配置部分使用
- 带 INI 标志的指令不能在 httpd.conf 中使用，只能用于 php.ini 中
- 在 .user.ini 风格的 INI 文件中，只有具有 PHP_INI_PERDIR 和 PHP_INI_USER 模式的INI设置能被识别
- 当使用 PHP 作为 Apache 的模块时，也可以用 Apache 的配置文件（httpd.conf、.htaccess等）中的指令来修改PHP配置设定，不过需要有 `AllowOverride Options` 或 `AllowOverride All` 权限















